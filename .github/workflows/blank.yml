name: Build OnePlus SM8650 Kernel + Devicetree (Verified)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      KERNEL_DIR: kernel
      MODULES_DT_DIR: modules_and_devicetree
      OUT_DIR: out

    steps:
    - name: Checkout workspace repo
      uses: actions/checkout@v4

    - name: Checkout Kernel repo (OnePlus upstream)
      uses: actions/checkout@v4
      with:
        repository: OnePlusOSS/android_kernel_oneplus_sm8650
        ref: oneplus/sm8650_v_16.0.0_oneplus12
        path: ${{ env.KERNEL_DIR }}

    - name: Checkout Modules + Devicetree repo (OnePlus upstream)
      uses: actions/checkout@v4
      with:
        repository: OnePlusOSS/android_kernel_modules_and_devicetree_oneplus_sm8650
        ref: oneplus/sm8650_v_16.0.0_oneplus12
        path: ${{ env.MODULES_DT_DIR }}

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          bc bison flex build-essential \
          libssl-dev libncurses-dev \
          python3 clang llvm lld tree ccache

    - name: Print workspace layout (sanity + path visibility)
      run: |
        echo "== WORKSPACE TREE (LEVEL 3) =="
        tree -L 3 || true
        echo "== IMPORTANT PATH CHECKS =="
        ls -R $KERNEL_DIR/arch/arm64/boot || true
        ls -R $MODULES_DT_DIR || true

    - name: Validate expected vendor paths exist
      run: |
        test -d $KERNEL_DIR/arch/arm64 || (echo "❌ Kernel arch tree missing" && exit 1)
        test -d $MODULES_DT_DIR || (echo "❌ Modules/DT repo missing" && exit 1)

    - name: Prepare OUT dir
      run: mkdir -p $OUT_DIR

    - name: Build DTBs (must succeed — fail loud)
      working-directory: ${{ env.MODULES_DT_DIR }}
      run: |
        set -x
        make O=../$OUT_DIR dtbs V=1 2>&1 | tee ../dtb_build.log
        echo "== DT OUTPUT FILES =="
        find ../$OUT_DIR/arch/arm64/boot/dts -type f || true
        test -d ../$OUT_DIR/arch/arm64/boot/dts || (echo "❌ DTS output missing" && exit 1)

    - name: Build Kernel Image (full verbose log)
      working-directory: ${{ env.KERNEL_DIR }}
      run: |
        set -x
        make O=../$OUT_DIR -j$(nproc) V=1 2>&1 | tee ../kernel_build.log
        ls -lh ../$OUT_DIR/arch/arm64/boot || true

    - name: Validate outputs (hard fail if missing)
      run: |
        test -f $OUT_DIR/arch/arm64/boot/Image || (echo "❌ Missing Image" && exit 1)
        test -d $OUT_DIR/arch/arm64/boot/dts || (echo "❌ Missing DTS output" && exit 1)

    - name: Upload full artifacts (everything we need to debug)
      uses: actions/upload-artifact@v4
      with:
        name: sm8650-build-full
        path: |
          out/**
          dtb_build.log
          kernel_build.log
          ${{ env.KERNEL_DIR }}/.config
          ${{ env.KERNEL_DIR }}/Makefile
          ${{ env.MODULES_DT_DIR }}/Makefile
        if-no-files-found: warn
