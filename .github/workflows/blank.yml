name: Build OnePlus SM8650 Kernel + Devicetree (Upstream 16.x)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      KERNEL_DIR: kernel
      MODULES_DT_DIR: modules_and_devicetree
      OUT_DIR: out

    steps:
    - name: Checkout workspace repo
      uses: actions/checkout@v4

    - name: Checkout Kernel repo (correct branch)
      uses: actions/checkout@v4
      with:
        repository: OnePlusOSS/android_kernel_oneplus_sm8650
        ref: oneplus/sm8650_b_16.0.0_oneplus12
        path: ${{ env.KERNEL_DIR }}

    - name: Checkout Modules + Devicetree repo (correct branch)
      uses: actions/checkout@v4
      with:
        repository: OnePlusOSS/android_kernel_modules_and_devicetree_oneplus_sm8650
        ref: oneplus/sm8650_b_16.0.0_oneplus12
        path: ${{ env.MODULES_DT_DIR }}

    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          bc bison flex build-essential \
          libssl-dev libncurses-dev \
          python3 clang llvm lld tree ccache

    - name: Print workspace layout (sanity check)
      run: |
        echo "== WORKSPACE TREE (level 3) =="
        tree -L 3 || true
        echo "== Kernel arch layout =="
        ls -R ${{ env.KERNEL_DIR }}/arch/arm64/boot || true
        echo "== Modules+DT layout =="
        ls -R ${{ env.MODULES_DT_DIR }} || true

    - name: Validate expected source locations
      run: |
        set -euo pipefail
        KERNEL_DTS_DIR="${{ env.KERNEL_DIR }}/arch/arm64/boot/dts"
        MODULES_DTS_DIR="${{ env.MODULES_DT_DIR }}/kernel_platform/qcom/proprietary/devicetree"
        MODULES_OPLUS_KERNEL_DIR="${{ env.MODULES_DT_DIR }}/vendor/oplus/kernel"
        WORKSPACE_OPLUS_KERNEL_DIR="vendor/oplus/kernel"
        echo "Expecting kernel DTS at: ${KERNEL_DTS_DIR}"
        echo "Expecting modules DTS at: ${MODULES_DTS_DIR}"
        echo "Expecting vendor oplus kernel sources at: ${MODULES_OPLUS_KERNEL_DIR}"
        echo "Expecting workspace vendor oplus kernel dir at: ${WORKSPACE_OPLUS_KERNEL_DIR}"
        test -d "${KERNEL_DTS_DIR}"
        test -d "${MODULES_DTS_DIR}"
        test -d "${MODULES_DTS_DIR}/qcom"
        test -d "${MODULES_DTS_DIR}/oplus"
        test -d "${MODULES_OPLUS_KERNEL_DIR}/cpu"
        test -d "${WORKSPACE_OPLUS_KERNEL_DIR}/cpu" || true

    - name: Sync OnePlus device trees into kernel tree
      run: |
        set -ex
        VENDOR_DTS_DIR="${{ env.KERNEL_DIR }}/arch/arm64/boot/dts/vendor"
        rm -rf "${VENDOR_DTS_DIR}"
        mkdir -p "${VENDOR_DTS_DIR}"
        rsync -a --delete "${{ env.MODULES_DT_DIR }}/kernel_platform/qcom/proprietary/devicetree/" "${VENDOR_DTS_DIR}/"
        ls -R "${VENDOR_DTS_DIR}" || true

    - name: Sync Oplus kernel sources into workspace
      run: |
        set -ex
        OPLUS_KERNEL_DIR="vendor/oplus/kernel"
        mkdir -p "${OPLUS_KERNEL_DIR}"
        rsync -a --delete "${{ env.MODULES_DT_DIR }}/vendor/oplus/kernel/" "${OPLUS_KERNEL_DIR}/"
        ls -R "${OPLUS_KERNEL_DIR}" || true

    - name: Fix Oplus CPU symlink in kernel tree
      run: |
        set -ex
        TARGET_DIR="../vendor/oplus/kernel/cpu"
        SYMLINK_PATH="${{ env.KERNEL_DIR }}/oplus_cpu"
        rm -f "${SYMLINK_PATH}"
        ln -s "${TARGET_DIR}" "${SYMLINK_PATH}"
        ls -l "${SYMLINK_PATH}"

    - name: Prepare output directory
      run: mkdir -p ${{ env.OUT_DIR }}

    - name: Configure kernel (GKI + Pineapple)
      working-directory: ${{ env.KERNEL_DIR }}
      run: |
        set -ex
        ARCH=arm64 ./scripts/kconfig/merge_config.sh -O ../${{ env.OUT_DIR }} \
          arch/arm64/configs/gki_defconfig \
          arch/arm64/configs/vendor/pineapple_GKI.config

    - name: Build Devicetrees (DTBs)
      working-directory: ${{ env.KERNEL_DIR }}
      run: |
        set -ex
        make O=../${{ env.OUT_DIR }} ARCH=arm64 dtbs V=1 2>&1 | tee ../dtb_build.log
        if [ ! -d ../${{ env.OUT_DIR }}/arch/arm64/boot/dts ]; then
          echo "❌ DTB output missing" >&2
          exit 1
        fi
        find ../${{ env.OUT_DIR }}/arch/arm64/boot/dts -type f

    - name: Build Kernel
      working-directory: ${{ env.KERNEL_DIR }}
      run: |
        set -ex
        make O=../${{ env.OUT_DIR }} ARCH=arm64 -j$(nproc) V=1 2>&1 | tee ../kernel_build.log
        ls -lh ../${{ env.OUT_DIR }}/arch/arm64/boot || true

    - name: Validate build outputs
      run: |
        if [ ! -f ${{ env.OUT_DIR }}/arch/arm64/boot/Image ]; then
          echo "❌ Kernel image missing" >&2
          exit 1
        fi
        if [ ! -d ${{ env.OUT_DIR }}/arch/arm64/boot/dts ]; then
          echo "❌ DTS directory missing" >&2
          exit 1
        fi

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sm8650-build-results
        path: |
          out/**
          dtb_build.log
          kernel_build.log
          ${{ env.KERNEL_DIR }}/.config
          ${{ env.KERNEL_DIR }}/Makefile
          ${{ env.MODULES_DT_DIR }}/Makefile
        if-no-files-found: warn
